import React, { useState } from 'react';
import { ArrowLeft, Filter, Search, TrendingUp, Star, Users, ThumbsUp, AlertTriangle, ChevronDown, SlidersHorizontal, X, CheckCircle, Package, Clock, Heart, ShoppingCart, Zap, Award, TrendingDown } from 'lucide-react';

const ProductListPage = () => {
  const [showFilters, setShowFilters] = useState(false);
  const [selectedFilters, setSelectedFilters] = useState({
    age: '3-6ä¸ªæœˆ',
    price: [],
    brand: [],
    material: [],
    feature: []
  });
  const [sortBy, setSortBy] = useState('smart');

  // ç­›é€‰é€‰é¡¹
  const filterOptions = {
    age: ['0-3ä¸ªæœˆ', '3-6ä¸ªæœˆ', '6-12ä¸ªæœˆ', '1-2å²'],
    price: [
      { id: '0-50', label: '50å…ƒä»¥ä¸‹' },
      { id: '50-100', label: '50-100å…ƒ' },
      { id: '100-200', label: '100-200å…ƒ' },
      { id: '200+', label: '200å…ƒä»¥ä¸Š' }
    ],
    brand: ['Comotomo', 'Dr.Brown', 'NUK', 'Pigeon', 'babycare'],
    material: ['PPSU', 'ç¡…èƒ¶', 'PP', 'ç»ç’ƒ'],
    feature: ['é˜²èƒ€æ°”', 'å®½å£å¾„', 'é˜²å‘›', 'é˜²æ¼', 'æ˜“æ¸…æ´—']
  };

  // äº§å“åˆ—è¡¨æ•°æ®
  const products = [
    {
      id: 1,
      name: 'Comotomoå¯ä¹ˆå¤šä¹ˆç¡…èƒ¶å¥¶ç“¶',
      brand: 'Comotomo',
      image: 'ğŸ¼',
      price: 128,
      originalPrice: 189,
      rating: 4.8,
      reviewCount: 234,
      recommendRate: 82,
      sameAgeUsers: 156,
      tags: ['é˜²èƒ€æ°”', 'ä»¿æ¯ä¹³', 'æ˜“æ¸…æ´—'],
      badges: ['å®å¦ˆé¦–é€‰', 'åŒæœˆé¾„çƒ­é—¨'],
      highlights: [
        '76%åŒæœˆé¾„æ¨è',
        'é˜²èƒ€æ°”æœ‰æ•ˆç‡89%',
        'å®å®æ¥å—åº¦92%'
      ],
      stock: 'å……è¶³',
      shipping: 'åŒ…é‚®',
      hasCoupon: true,
      couponAmount: 20,
      isHot: true,
      effectiveness: 89,
      stillUsingRate: 81
    },
    {
      id: 2,
      name: 'Dr.Brownå¸ƒæœ—åšå£«é˜²èƒ€æ°”å¥¶ç“¶',
      brand: 'Dr.Brown',
      image: 'ğŸ¼',
      price: 98,
      originalPrice: 158,
      rating: 4.6,
      reviewCount: 189,
      recommendRate: 76,
      sameAgeUsers: 134,
      tags: ['é˜²èƒ€æ°”', 'åŒ»ç”Ÿæ¨è', 'æ€§ä»·æ¯”'],
      badges: ['é«˜æ€§ä»·æ¯”'],
      highlights: [
        'ä¸“åˆ©é˜²èƒ€æ°”è®¾è®¡',
        'åŒ»ç”Ÿæ¨èç‡é«˜',
        '68%åŒæœˆé¾„æ¨è'
      ],
      stock: 'å……è¶³',
      shipping: 'åŒ…é‚®',
      hasCoupon: true,
      couponAmount: 10,
      isHot: false,
      effectiveness: 82,
      stillUsingRate: 74
    },
    {
      id: 3,
      name: 'NUKè‡ªç„¶å®æ„Ÿå®½å£å¾„å¥¶ç“¶',
      brand: 'NUK',
      image: 'ğŸ¼',
      price: 78,
      originalPrice: 128,
      rating: 4.5,
      reviewCount: 167,
      recommendRate: 68,
      sameAgeUsers: 98,
      tags: ['å®½å£å¾„', 'æ˜“æ¸…æ´—', 'å®æƒ '],
      badges: [],
      highlights: [
        'å®½å£è®¾è®¡æ˜“æ¸…æ´—',
        'å¾·å›½å“ç‰Œ',
        'æ€§ä»·æ¯”å¥½'
      ],
      stock: 'å……è¶³',
      shipping: 'åŒ…é‚®',
      hasCoupon: false,
      couponAmount: 0,
      isHot: false,
      effectiveness: 76,
      stillUsingRate: 68
    },
    {
      id: 4,
      name: 'Pigeonè´äº²æ¯ä¹³å®æ„Ÿå¥¶ç“¶',
      brand: 'Pigeon',
      image: 'ğŸ¼',
      price: 88,
      originalPrice: 138,
      rating: 4.4,
      reviewCount: 145,
      recommendRate: 72,
      sameAgeUsers: 87,
      tags: ['ä»¿æ¯ä¹³', 'æ—¥æœ¬å“ç‰Œ'],
      badges: [],
      highlights: [
        'æ¯ä¹³å®æ„Ÿè®¾è®¡',
        'æ—¥æœ¬è¿›å£',
        'å“è´¨å¯é '
      ],
      stock: 'å°‘é‡',
      shipping: 'åŒ…é‚®',
      hasCoupon: true,
      couponAmount: 15,
      isHot: false,
      effectiveness: 78,
      stillUsingRate: 70
    },
    {
      id: 5,
      name: 'babycareå®½å£PPSUå¥¶ç“¶',
      brand: 'babycare',
      image: 'ğŸ¼',
      price: 68,
      originalPrice: 98,
      rating: 4.3,
      reviewCount: 123,
      recommendRate: 65,
      sameAgeUsers: 76,
      tags: ['PPSU', 'é˜²æ‘”', 'è½»ä¾¿'],
      badges: [],
      highlights: [
        'PPSUæè´¨è€ç”¨',
        'é˜²æ‘”ä¸æ˜“ç¢',
        'ä»·æ ¼å®æƒ '
      ],
      stock: 'å……è¶³',
      shipping: 'æ»¡99åŒ…é‚®',
      hasCoupon: false,
      couponAmount: 0,
      isHot: false,
      effectiveness: 70,
      stillUsingRate: 64
    }
  ];

  const [filteredProducts, setFilteredProducts] = useState(products);
  const [likedProducts, setLikedProducts] = useState([]);

  const toggleFilter = (category, value) => {
    if (category === 'age') {
      setSelectedFilters({ ...selectedFilters, age: value });
    } else {
      const current = selectedFilters[category];
      const updated = current.includes(value)
        ? current.filter(v => v !== value)
        : [...current, value];
      setSelectedFilters({ ...selectedFilters, [category]: updated });
    }
  };

  const clearFilters = () => {
    setSelectedFilters({
      age: '3-6ä¸ªæœˆ',
      price: [],
      brand: [],
      material: [],
      feature: []
    });
  };

  const toggleLike = (productId) => {
    setLikedProducts(prev => 
      prev.includes(productId) 
        ? prev.filter(id => id !== productId)
        : [...prev, productId]
    );
  };

  const getActiveFilterCount = () => {
    return selectedFilters.price.length + 
           selectedFilters.brand.length + 
           selectedFilters.material.length + 
           selectedFilters.feature.length;
  };

  const renderFilterModal = () => {
    if (!showFilters) return null;

    return (
      <div className="fixed inset-0 bg-black/50 z-50 flex flex-col">
        <div className="bg-white flex-1 overflow-y-auto">
          {/* ç­›é€‰å¤´éƒ¨ */}
          <div className="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between z-10">
            <button onClick={clearFilters} className="text-sm text-gray-600">
              æ¸…ç©º
            </button>
            <span className="font-semibold">ç­›é€‰</span>
            <button onClick={() => setShowFilters(false)}>
              <X className="w-5 h-5" />
            </button>
          </div>

          <div className="p-4 space-y-6">
            {/* å®å®æœˆé¾„ */}
            <div>
              <div className="font-semibold text-gray-800 mb-3">å®å®æœˆé¾„</div>
              <div className="grid grid-cols-2 gap-2">
                {filterOptions.age.map((age) => (
                  <button
                    key={age}
                    onClick={() => toggleFilter('age', age)}
                    className={`py-2 rounded-lg text-sm font-medium transition-all ${
                      selectedFilters.age === age
                        ? 'bg-blue-500 text-white'
                        : 'bg-gray-100 text-gray-700'
                    }`}
                  >
                    {age}
                  </button>
                ))}
              </div>
            </div>

            {/* ä»·æ ¼åŒºé—´ */}
            <div>
              <div className="font-semibold text-gray-800 mb-3">ä»·æ ¼åŒºé—´</div>
              <div className="grid grid-cols-2 gap-2">
                {filterOptions.price.map((price) => (
                  <button
                    key={price.id}
                    onClick={() => toggleFilter('price', price.id)}
                    className={`py-2 rounded-lg text-sm font-medium transition-all ${
                      selectedFilters.price.includes(price.id)
                        ? 'bg-blue-500 text-white'
                        : 'bg-gray-100 text-gray-700'
                    }`}
                  >
                    {price.label}
                  </button>
                ))}
              </div>
            </div>

            {/* å“ç‰Œ */}
            <div>
              <div className="font-semibold text-gray-800 mb-3">å“ç‰Œ</div>
              <div className="flex flex-wrap gap-2">
                {filterOptions.brand.map((brand) => (
                  <button
                    key={brand}
                    onClick={() => toggleFilter('brand', brand)}
                    className={`px-3 py-1.5 rounded-full text-sm transition-all ${
                      selectedFilters.brand.includes(brand)
                        ? 'bg-blue-500 text-white'
                        : 'bg-gray-100 text-gray-700'
                    }`}
                  >
                    {brand}
                  </button>
                ))}
              </div>
            </div>

            {/* æè´¨ */}
            <div>
              <div className="font-semibold text-gray-800 mb-3">æè´¨</div>
              <div className="flex flex-wrap gap-2">
                {filterOptions.material.map((material) => (
                  <button
                    key={material}
                    onClick={() => toggleFilter('material', material)}
                    className={`px-3 py-1.5 rounded-full text-sm transition-all ${
                      selectedFilters.material.includes(material)
                        ? 'bg-blue-500 text-white'
                        : 'bg-gray-100 text-gray-700'
                    }`}
                  >
                    {material}
                  </button>
                ))}
              </div>
            </div>

            {/* åŠŸèƒ½ç‰¹ç‚¹ */}
            <div>
              <div className="font-semibold text-gray-800 mb-3">åŠŸèƒ½ç‰¹ç‚¹</div>
              <div className="flex flex-wrap gap-2">
                {filterOptions.feature.map((feature) => (
                  <button
                    key={feature}
                    onClick={() => toggleFilter('feature', feature)}
                    className={`px-3 py-1.5 rounded-full text-sm transition-all ${
                      selectedFilters.feature.includes(feature)
                        ? 'bg-blue-500 text-white'
                        : 'bg-gray-100 text-gray-700'
                    }`}
                  >
                    {feature}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* åº•éƒ¨æŒ‰é’® */}
        <div className="bg-white border-t px-4 py-3">
          <button
            onClick={() => setShowFilters(false)}
            className="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl font-semibold"
          >
            æŸ¥çœ‹ç»“æœ
          </button>
        </div>
      </div>
    );
  };

  const renderProductCard = (product) => (
    <div key={product.id} className="bg-white rounded-2xl p-4 border border-gray-200 shadow-sm hover:shadow-md transition-all">
      {/* é¡¶éƒ¨æ ‡ç­¾ */}
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          {product.isHot && (
            <span className="text-xs bg-red-500 text-white px-2 py-0.5 rounded-full font-semibold">
              ğŸ”¥ çƒ­é—¨
            </span>
          )}
          {product.badges.map((badge, idx) => (
            <span key={idx} className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-semibold">
              {badge}
            </span>
          ))}
        </div>
        <button 
          onClick={() => toggleLike(product.id)}
          className="p-1"
        >
          <Heart className={`w-5 h-5 ${
            likedProducts.includes(product.id) 
              ? 'fill-red-500 text-red-500' 
              : 'text-gray-400'
          }`} />
        </button>
      </div>

      {/* äº§å“ä¸»ä½“ */}
      <div className="flex gap-3 mb-3">
        <div className="w-24 h-24 bg-gray-100 rounded-xl flex items-center justify-center text-5xl flex-shrink-0 border border-gray-200">
          {product.image}
        </div>
        <div className="flex-1 min-w-0">
          <div className="text-xs text-gray-500 mb-1">{product.brand}</div>
          <div className="font-semibold text-sm text-gray-800 mb-2 line-clamp-2">
            {product.name}
          </div>
          <div className="flex items-center gap-1 mb-2">
            <Star className="w-3 h-3 fill-yellow-400 text-yellow-400" />
            <span className="text-sm font-semibold">{product.rating}</span>
            <span className="text-xs text-gray-500">({product.reviewCount})</span>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-red-500 font-bold text-lg">Â¥{product.price}</span>
            <span className="text-xs text-gray-400 line-through">Â¥{product.originalPrice}</span>
          </div>
        </div>
      </div>

      {/* åŒæœˆé¾„æ•°æ® */}
      <div className="bg-blue-50 rounded-lg p-2 mb-3">
        <div className="grid grid-cols-3 gap-2 text-center">
          <div>
            <div className="text-sm font-bold text-blue-600">{product.recommendRate}%</div>
            <div className="text-xs text-gray-600">æ¨èç‡</div>
          </div>
          <div>
            <div className="text-sm font-bold text-green-600">{product.effectiveness}%</div>
            <div className="text-xs text-gray-600">æœ‰æ•ˆç‡</div>
          </div>
          <div>
            <div className="text-sm font-bold text-purple-600">{product.sameAgeUsers}</div>
            <div className="text-xs text-gray-600">åŒæœˆé¾„</div>
          </div>
        </div>
      </div>

      {/* äº®ç‚¹ */}
      <div className="bg-green-50 rounded-lg p-2 mb-3">
        <div className="space-y-1">
          {product.highlights.slice(0, 2).map((highlight, idx) => (
            <div key={idx} className="flex items-start gap-1 text-xs text-gray-700">
              <CheckCircle className="w-3 h-3 text-green-600 flex-shrink-0 mt-0.5" />
              <span>{highlight}</span>
            </div>
          ))}
        </div>
      </div>

      {/* æ ‡ç­¾ */}
      <div className="flex flex-wrap gap-1.5 mb-3">
        {product.tags.map((tag, idx) => (
          <span key={idx} className="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded">
            {tag}
          </span>
        ))}
      </div>

      {/* é…é€ä¿¡æ¯ */}
      <div className="flex items-center justify-between text-xs text-gray-500 mb-3">
        <div className="flex items-center gap-2">
          <Package className="w-3 h-3" />
          <span>{product.shipping}</span>
        </div>
        <span className={product.stock === 'å……è¶³' ? 'text-green-600' : 'text-orange-600'}>
          {product.stock === 'å……è¶³' ? 'åº“å­˜å……è¶³' : 'åº“å­˜ç´§å¼ '}
        </span>
      </div>

      {/* ä¼˜æƒ åˆ¸ */}
      {product.hasCoupon && (
        <div className="bg-orange-50 border border-orange-200 rounded-lg p-2 mb-3 flex items-center justify-between">
          <div className="flex items-center gap-1 text-xs text-orange-700">
            <Award className="w-3 h-3" />
            <span>é¢†åˆ¸ç«‹å‡Â¥{product.couponAmount}</span>
          </div>
          <button className="text-xs text-orange-600 font-semibold">
            é¢†å– â†’
          </button>
        </div>
      )}

      {/* æ“ä½œæŒ‰é’® */}
      <div className="flex gap-2">
        <button className="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white py-2.5 rounded-xl font-semibold text-sm">
          æŸ¥çœ‹è¯¦æƒ…
        </button>
        <button className="px-4 bg-orange-500 text-white py-2.5 rounded-xl">
          <ShoppingCart className="w-4 h-4" />
        </button>
      </div>
    </div>
  );

  return (
    <div className="max-w-md mx-auto bg-gray-50 min-h-screen flex flex-col">
      {/* é¡¶éƒ¨å¯¼èˆª */}
      <div className="bg-white px-4 py-3 border-b sticky top-0 z-40">
        <div className="flex items-center gap-3 mb-3">
          <button>
            <ArrowLeft className="w-5 h-5" />
          </button>
          <div className="flex-1 relative">
            <Search className="w-4 h-4 text-gray-400 absolute left-3 top-2.5" />
            <input
              type="text"
              placeholder="æœç´¢äº§å“..."
              className="w-full pl-9 pr-3 py-2 bg-gray-100 rounded-lg text-sm focus:outline-none focus:bg-white focus:border focus:border-blue-500"
            />
          </div>
        </div>

        {/* é€‰ä¸­çš„ç­›é€‰æ¡ä»¶ */}
        <div className="flex items-center gap-2 text-xs">
          <span className="text-gray-600">å½“å‰ï¼š</span>
          <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded">
            {selectedFilters.age}
          </span>
          {getActiveFilterCount() > 0 && (
            <span className="bg-purple-100 text-purple-700 px-2 py-1 rounded">
              +{getActiveFilterCount()}ä¸ªç­›é€‰
            </span>
          )}
        </div>
      </div>

      {/* æ’åºå’Œç­›é€‰æ  */}
      <div className="bg-white px-4 py-2 border-b flex items-center justify-between sticky top-24 z-30">
        <div className="flex items-center gap-2 flex-1 overflow-x-auto">
          <button
            onClick={() => setSortBy('smart')}
            className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap ${
              sortBy === 'smart'
                ? 'bg-blue-500 text-white'
                : 'bg-gray-100 text-gray-700'
            }`}
          >
            <Zap className="w-3 h-3 inline mr-1" />
            æ™ºèƒ½æ¨è
          </button>
          <button
            onClick={() => setSortBy('recommend')}
            className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap ${
              sortBy === 'recommend'
                ? 'bg-blue-500 text-white'
                : 'bg-gray-100 text-gray-700'
            }`}
          >
            æ¨èç‡
          </button>
          <button
            onClick={() => setSortBy('price-asc')}
            className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap ${
              sortBy === 'price-asc'
                ? 'bg-blue-500 text-white'
                : 'bg-gray-100 text-gray-700'
            }`}
          >
            ä»·æ ¼ â†‘
          </button>
          <button
            onClick={() => setSortBy('sales')}
            className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap ${
              sortBy === 'sales'
                ? 'bg-blue-500 text-white'
                : 'bg-gray-100 text-gray-700'
            }`}
          >
            é”€é‡
          </button>
        </div>
        
        <button
          onClick={() => setShowFilters(true)}
          className="ml-2 flex items-center gap-1 px-3 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-700 whitespace-nowrap relative"
        >
          <SlidersHorizontal className="w-3 h-3" />
          ç­›é€‰
          {getActiveFilterCount() > 0 && (
            <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
              {getActiveFilterCount()}
            </span>
          )}
        </button>
      </div>

      {/* äº§å“åˆ—è¡¨ */}
      <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-20">
        {/* ç»“æœç»Ÿè®¡ */}
        <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-3 border border-blue-200">
          <div className="text-sm text-gray-700">
            ä¸º<span className="text-blue-600 font-bold mx-1">{selectedFilters.age}å®å®</span>
            æ‰¾åˆ°<span className="text-purple-600 font-bold mx-1">{filteredProducts.length}</span>
            ä¸ªäº§å“
          </div>
        </div>

        {filteredProducts.map(renderProductCard)}

        {/* åŠ è½½æ›´å¤š */}
        <button className="w-full py-4 text-sm text-gray-600 border border-gray-200 rounded-xl bg-white">
          æŸ¥çœ‹æ›´å¤šäº§å“ â†’
        </button>
      </div>

      {/* ç­›é€‰å¼¹çª— */}
      {renderFilterModal()}
    </div>
  );
};

export default ProductListPage;
