import React, { useState } from 'react';
import { ArrowLeft, Sparkles, Filter, Heart, Star, TrendingUp, Users, CheckCircle, AlertTriangle, ChevronRight, ShoppingCart, Share2, ThumbsUp, Clock, Package, Zap, Award, Eye, MessageSquare, BookmarkPlus, Info, RefreshCw } from 'lucide-react';

const SmartRecommendationPage = () => {
  const [showFilters, setShowFilters] = useState(false);
  const [sortBy, setSortBy] = useState('smart');
  const [selectedForCompare, setSelectedForCompare] = useState([]);

  // ç­›é€‰æ¡ä»¶
  const filters = {
    babyAge: '3-6ä¸ªæœˆ',
    problem: 'é˜²èƒ€æ°”',
    budget: '50-150å…ƒ',
    resultCount: 8
  };

  // æ™ºèƒ½æ¨èç»“è®º
  const smartConclusion = {
    bestMatch: {
      id: 1,
      name: 'Comotomoå¯ä¹ˆå¤šä¹ˆç¡…èƒ¶å¥¶ç“¶',
      brand: 'Comotomo',
      matchScore: 95,
      reason: 'æœ€é€‚åˆä½ çš„å®å®'
    },
    keyPoints: [
      '76%çš„3-6ä¸ªæœˆåŒæœˆé¾„å®å¦ˆæ¨è',
      'é˜²èƒ€æ°”æœ‰æ•ˆç‡89%ï¼Œæ˜æ˜¾é«˜äºå¹³å‡æ°´å¹³',
      'æŸ”è½¯åº¦æ¥è¿‘æ¯ä¹³ï¼Œå®å®æ¥å—åº¦92%',
      'ä»·æ ¼ç•¥é«˜ä½†ä½¿ç”¨ä½“éªŒæ›´å¥½ï¼Œå€¼å¾—æŠ•èµ„'
    ],
    alternatives: 'å¦‚æœé¢„ç®—æœ‰é™ï¼ŒDr.Brownä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©'
  };

  // æ¨èäº§å“åˆ—è¡¨
  const recommendations = [
    {
      id: 1,
      rank: 1,
      name: 'Comotomoå¯ä¹ˆå¤šä¹ˆç¡…èƒ¶å¥¶ç“¶',
      brand: 'Comotomo',
      model: '250ml',
      image: 'ğŸ¼',
      price: 128,
      originalPrice: 189,
      discount: 32,
      rating: 4.8,
      reviewCount: 234,
      matchScore: 95,
      badges: ['æœ€ä½³åŒ¹é…', 'å®å¦ˆé¦–é€‰'],
      reasons: [
        '76%åŒæœˆé¾„æ¨è',
        'é˜²èƒ€æ°”89%æœ‰æ•ˆ',
        'å®å®æ¥å—åº¦92%'
      ],
      pros: ['é˜²èƒ€æ°”æœ‰æ•ˆ', 'æ˜“æ¸…æ´—', 'å®å®å–œæ¬¢'],
      cons: ['ä»·æ ¼ç¨é«˜', 'ç¡…èƒ¶æ˜“æ²¾ç°'],
      stats: {
        sameAgeUsers: 156,
        sameAgeRate: 76,
        stillUsing: 189,
        repurchase: 45,
        effectiveness: 89
      },
      tags: ['é˜²èƒ€æ°”', 'ä»¿æ¯ä¹³', 'æ˜“æ¸…æ´—'],
      platforms: [
        { name: 'æ·˜å®', price: 128, coupon: 20, final: 108 },
        { name: 'äº¬ä¸œ', price: 135, coupon: 15, final: 120 }
      ]
    },
    {
      id: 2,
      rank: 2,
      name: 'Dr.Brownå¸ƒæœ—åšå£«é˜²èƒ€æ°”å¥¶ç“¶',
      brand: 'Dr.Brown',
      model: '240ml',
      image: 'ğŸ¼',
      price: 98,
      originalPrice: 158,
      discount: 38,
      rating: 4.6,
      reviewCount: 189,
      matchScore: 88,
      badges: ['é«˜æ€§ä»·æ¯”', 'åŒ»ç”Ÿæ¨è'],
      reasons: [
        'ä¸“åˆ©é˜²èƒ€æ°”è®¾è®¡',
        'åŒ»ç”Ÿæ¨èç‡é«˜',
        'æ€§ä»·æ¯”å‡ºè‰²'
      ],
      pros: ['é˜²èƒ€æ°”', 'ä»·æ ¼é€‚ä¸­', 'åŒ»ç”Ÿæ¨è'],
      cons: ['é…ä»¶å¤š', 'æ¸…æ´—éº»çƒ¦'],
      stats: {
        sameAgeUsers: 134,
        sameAgeRate: 68,
        stillUsing: 156,
        repurchase: 32,
        effectiveness: 82
      },
      tags: ['é˜²èƒ€æ°”', 'åŒ»ç”Ÿæ¨è', 'æ€§ä»·æ¯”'],
      platforms: [
        { name: 'æ·˜å®', price: 98, coupon: 10, final: 88 },
        { name: 'äº¬ä¸œ', price: 102, coupon: 10, final: 92 }
      ]
    },
    {
      id: 3,
      rank: 3,
      name: 'NUKè‡ªç„¶å®æ„Ÿå®½å£å¾„å¥¶ç“¶',
      brand: 'NUK',
      model: '260ml',
      image: 'ğŸ¼',
      price: 78,
      originalPrice: 128,
      discount: 39,
      rating: 4.5,
      reviewCount: 167,
      matchScore: 82,
      badges: ['é¢„ç®—å‹å¥½'],
      reasons: [
        'å¾·å›½å“ç‰Œè´¨é‡å¥½',
        'å®½å£æ˜“æ¸…æ´—',
        'ä»·æ ¼å®æƒ '
      ],
      pros: ['æ˜“æ¸…æ´—', 'ä»·æ ¼ä½', 'è´¨é‡å¥½'],
      cons: ['é˜²èƒ€æ°”ä¸€èˆ¬', 'å¥¶å˜´åç¡¬'],
      stats: {
        sameAgeUsers: 98,
        sameAgeRate: 62,
        stillUsing: 123,
        repurchase: 28,
        effectiveness: 76
      },
      tags: ['å®½å£å¾„', 'æ˜“æ¸…æ´—', 'å®æƒ '],
      platforms: [
        { name: 'æ·˜å®', price: 78, coupon: 8, final: 70 },
        { name: 'äº¬ä¸œ', price: 82, coupon: 8, final: 74 }
      ]
    }
  ];

  const handleCompareToggle = (productId) => {
    if (selectedForCompare.includes(productId)) {
      setSelectedForCompare(selectedForCompare.filter(id => id !== productId));
    } else if (selectedForCompare.length < 3) {
      setSelectedForCompare([...selectedForCompare, productId]);
    }
  };

  const renderSmartConclusion = () => (
    <div className="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 rounded-2xl p-4 mb-4 border-2 border-blue-200">
      <div className="flex items-center gap-2 mb-3">
        <div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg flex items-center justify-center">
          <Sparkles className="w-5 h-5 text-white" />
        </div>
        <h2 className="font-bold text-gray-800">æ™ºèƒ½æ¨èç»“è®º</h2>
        <span className="text-xs text-purple-600 bg-purple-100 px-2 py-0.5 rounded-full ml-auto">
          AIåˆ†æ
        </span>
      </div>

      {/* æœ€ä½³åŒ¹é… */}
      <div className="bg-white rounded-xl p-4 mb-3 border-2 border-green-300">
        <div className="flex items-center gap-2 mb-2">
          <Award className="w-5 h-5 text-green-600" />
          <span className="text-sm font-semibold text-green-700">æœ€é€‚åˆä½ çš„å®å®</span>
        </div>
        <div className="font-bold text-lg text-gray-800 mb-1">
          {smartConclusion.bestMatch.name}
        </div>
        <div className="flex items-center gap-2">
          <div className="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-semibold">
            åŒ¹é…åº¦ {smartConclusion.bestMatch.matchScore}%
          </div>
          <button className="text-xs text-blue-600 font-medium">
            æŸ¥çœ‹è¯¦æƒ… â†’
          </button>
        </div>
      </div>

      {/* æ¨èç†ç”± */}
      <div className="bg-white rounded-xl p-3 mb-3">
        <div className="text-xs font-semibold text-gray-700 mb-2">ğŸ’¡ ä¸ºä»€ä¹ˆæ¨è</div>
        <div className="space-y-1.5">
          {smartConclusion.keyPoints.map((point, idx) => (
            <div key={idx} className="flex items-start gap-2 text-xs text-gray-700">
              <CheckCircle className="w-3.5 h-3.5 text-green-600 flex-shrink-0 mt-0.5" />
              <span>{point}</span>
            </div>
          ))}
        </div>
      </div>

      {/* å¤‡é€‰æ–¹æ¡ˆ */}
      <div className="bg-orange-50 rounded-lg p-2">
        <div className="text-xs text-orange-800">
          <Info className="w-3 h-3 inline mr-1" />
          {smartConclusion.alternatives}
        </div>
      </div>
    </div>
  );

  const renderProductCard = (product) => (
    <div key={product.id} className="bg-white rounded-2xl p-4 shadow-md border-2 border-gray-200 hover:border-blue-300 transition-all">
      {/* æ’åå’ŒåŒ¹é…åº¦ */}
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${
            product.rank === 1 
              ? 'bg-gradient-to-r from-yellow-400 to-orange-400'
              : product.rank === 2
              ? 'bg-gradient-to-r from-gray-300 to-gray-400'
              : 'bg-gradient-to-r from-orange-300 to-orange-400'
          }`}>
            {product.rank}
          </div>
          <div className={`px-3 py-1 rounded-full text-xs font-bold ${
            product.matchScore >= 90 
              ? 'bg-green-100 text-green-700'
              : product.matchScore >= 80
              ? 'bg-blue-100 text-blue-700'
              : 'bg-gray-100 text-gray-700'
          }`}>
            <Zap className="w-3 h-3 inline mr-1" />
            åŒ¹é… {product.matchScore}%
          </div>
        </div>
        
        <button 
          onClick={() => handleCompareToggle(product.id)}
          className={`p-2 rounded-lg ${
            selectedForCompare.includes(product.id)
              ? 'bg-blue-500 text-white'
              : 'bg-gray-100 text-gray-600'
          }`}
        >
          <Heart className={`w-5 h-5 ${selectedForCompare.includes(product.id) ? 'fill-current' : ''}`} />
        </button>
      </div>

      {/* å¾½ç«  */}
      {product.badges.length > 0 && (
        <div className="flex gap-2 mb-3">
          {product.badges.map((badge, idx) => (
            <span key={idx} className={`text-xs px-2 py-1 rounded-full font-semibold ${
              badge === 'æœ€ä½³åŒ¹é…' ? 'bg-red-500 text-white' :
              badge === 'å®å¦ˆé¦–é€‰' ? 'bg-purple-500 text-white' :
              badge === 'é«˜æ€§ä»·æ¯”' ? 'bg-green-500 text-white' :
              badge === 'åŒ»ç”Ÿæ¨è' ? 'bg-blue-500 text-white' :
              'bg-orange-500 text-white'
            }`}>
              {badge}
            </span>
          ))}
        </div>
      )}

      {/* äº§å“ä¿¡æ¯ */}
      <div className="flex gap-3 mb-3">
        <div className="w-24 h-24 bg-gray-100 rounded-xl flex items-center justify-center text-5xl flex-shrink-0 border border-gray-200">
          {product.image}
        </div>
        <div className="flex-1">
          <div className="text-xs text-gray-500 mb-1">{product.brand}</div>
          <div className="font-semibold text-gray-800 mb-1 line-clamp-2">
            {product.name}
          </div>
          <div className="text-xs text-gray-500 mb-2">{product.model}</div>
          <div className="flex items-center gap-2">
            <span className="text-red-500 font-bold text-xl">Â¥{product.price}</span>
            <span className="text-xs text-gray-400 line-through">Â¥{product.originalPrice}</span>
            <span className="text-xs text-red-500 bg-red-50 px-2 py-0.5 rounded">
              çœ{product.discount}%
            </span>
          </div>
          <div className="flex items-center gap-1 mt-1">
            <Star className="w-3 h-3 fill-yellow-400 text-yellow-400" />
            <span className="text-sm font-semibold">{product.rating}</span>
            <span className="text-xs text-gray-500">({product.reviewCount})</span>
          </div>
        </div>
      </div>

      {/* æ¨èç†ç”± */}
      <div className="bg-blue-50 rounded-xl p-3 mb-3">
        <div className="text-xs text-blue-800 font-semibold mb-2">
          <CheckCircle className="w-3 h-3 inline mr-1" />
          ä¸ºä»€ä¹ˆæ¨è
        </div>
        <div className="space-y-1">
          {product.reasons.map((reason, idx) => (
            <div key={idx} className="flex items-start gap-2 text-xs text-gray-700">
              <div className="w-1 h-1 bg-blue-500 rounded-full mt-1.5 flex-shrink-0"></div>
              <span>{reason}</span>
            </div>
          ))}
        </div>
      </div>

      {/* åŒæœˆé¾„æ•°æ® */}
      <div className="bg-purple-50 rounded-xl p-3 mb-3">
        <div className="text-xs text-purple-700 font-semibold mb-2">
          <Users className="w-3 h-3 inline mr-1" />
          åŒæœˆé¾„çœŸå®æ•°æ®
        </div>
        <div className="grid grid-cols-2 gap-2">
          <div>
            <div className="text-lg font-bold text-purple-600">{product.stats.sameAgeUsers}</div>
            <div className="text-xs text-gray-600">ä½å®å¦ˆä½¿ç”¨</div>
          </div>
          <div>
            <div className="text-lg font-bold text-green-600">{product.stats.sameAgeRate}%</div>
            <div className="text-xs text-gray-600">æ¨èç‡</div>
          </div>
          <div>
            <div className="text-lg font-bold text-blue-600">{product.stats.stillUsing}</div>
            <div className="text-xs text-gray-600">ä»åœ¨ä½¿ç”¨</div>
          </div>
          <div>
            <div className="text-lg font-bold text-orange-600">{product.stats.effectiveness}%</div>
            <div className="text-xs text-gray-600">é˜²èƒ€æ°”æœ‰æ•ˆ</div>
          </div>
        </div>
      </div>

      {/* ä¼˜ç¼ºç‚¹ */}
      <div className="grid grid-cols-2 gap-2 mb-3">
        <div className="bg-green-50 rounded-lg p-2">
          <div className="text-xs text-green-700 font-semibold mb-1">
            <ThumbsUp className="w-3 h-3 inline mr-1" />
            ä¼˜ç‚¹
          </div>
          <div className="space-y-1">
            {product.pros.slice(0, 2).map((pro, idx) => (
              <div key={idx} className="text-xs text-gray-700">â€¢ {pro}</div>
            ))}
          </div>
        </div>
        <div className="bg-orange-50 rounded-lg p-2">
          <div className="text-xs text-orange-700 font-semibold mb-1">
            <AlertTriangle className="w-3 h-3 inline mr-1" />
            ç¼ºç‚¹
          </div>
          <div className="space-y-1">
            {product.cons.slice(0, 2).map((con, idx) => (
              <div key={idx} className="text-xs text-gray-700">â€¢ {con}</div>
            ))}
          </div>
        </div>
      </div>

      {/* è´­ä¹°æ¸ é“ */}
      <div className="bg-gray-50 rounded-lg p-3 mb-3">
        <div className="text-xs text-gray-600 mb-2">æœ€ä½ä»·</div>
        <div className="flex items-center justify-between">
          <div>
            <div className="text-sm font-semibold text-gray-800">{product.platforms[0].name}</div>
            <div className="flex items-center gap-2">
              <span className="text-lg font-bold text-red-500">Â¥{product.platforms[0].final}</span>
              <span className="text-xs text-orange-600">åˆ¸{product.platforms[0].coupon}å…ƒ</span>
            </div>
          </div>
          <button className="bg-gradient-to-r from-orange-400 to-red-500 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-1">
            <ShoppingCart className="w-4 h-4" />
            ç«‹å³è´­ä¹°
          </button>
        </div>
      </div>

      {/* æ“ä½œæŒ‰é’® */}
      <div className="flex gap-2">
        <button className="flex-1 bg-blue-500 text-white py-3 rounded-xl font-semibold text-sm">
          æŸ¥çœ‹è¯¦æƒ…
        </button>
        <button 
          onClick={() => handleCompareToggle(product.id)}
          className={`px-4 py-3 rounded-xl font-semibold text-sm ${
            selectedForCompare.includes(product.id)
              ? 'bg-blue-500 text-white'
              : 'bg-gray-100 text-gray-700'
          }`}
        >
          {selectedForCompare.includes(product.id) ? 'å·²é€‰' : 'å¯¹æ¯”'}
        </button>
      </div>
    </div>
  );

  return (
    <div className="max-w-md mx-auto bg-gray-50 min-h-screen flex flex-col">
      {/* é¡¶éƒ¨å¯¼èˆª */}
      <div className="bg-white px-4 py-3 flex items-center justify-between shadow-sm sticky top-0 z-50">
        <button className="flex items-center gap-2">
          <ArrowLeft className="w-5 h-5" />
          <span className="font-semibold">æ¨èç»“æœ</span>
        </button>
        <div className="flex items-center gap-3">
          <button onClick={() => setShowFilters(!showFilters)}>
            <Filter className="w-5 h-5 text-gray-600" />
          </button>
          <button>
            <Share2 className="w-5 h-5 text-gray-600" />
          </button>
        </div>
      </div>

      {/* ç­›é€‰æ¡ä»¶æ€»ç»“ */}
      <div className="bg-gradient-to-r from-blue-500 to-purple-500 px-4 py-3 text-white">
        <div className="flex items-center justify-between mb-2">
          <h2 className="font-bold">ä¸ºä½ ç²¾é€‰</h2>
          <button className="text-xs flex items-center gap-1 bg-white/20 px-2 py-1 rounded">
            <RefreshCw className="w-3 h-3" />
            é‡æ–°é€‰æ‹©
          </button>
        </div>
        <div className="flex flex-wrap gap-2 mb-2">
          <span className="text-xs bg-white/30 px-2 py-1 rounded-full">
            {filters.babyAge}å®å®
          </span>
          <span className="text-xs bg-white/30 px-2 py-1 rounded-full">
            {filters.problem}é—®é¢˜
          </span>
          <span className="text-xs bg-white/30 px-2 py-1 rounded-full">
            {filters.budget}é¢„ç®—
          </span>
        </div>
        <div className="text-sm opacity-90">
          æ‰¾åˆ° <span className="font-bold">{filters.resultCount}</span> ä¸ªç¬¦åˆæ¡ä»¶çš„äº§å“
        </div>
      </div>

      {/* æ’åºæ–¹å¼ */}
      <div className="bg-white px-4 py-2 border-b flex items-center gap-2 overflow-x-auto">
        <button
          onClick={() => setSortBy('smart')}
          className={`px-3 py-1 rounded-full text-xs whitespace-nowrap ${
            sortBy === 'smart'
              ? 'bg-blue-500 text-white'
              : 'bg-gray-100 text-gray-700'
          }`}
        >
          æ™ºèƒ½æ¨è
        </button>
        <button
          onClick={() => setSortBy('rate')}
          className={`px-3 py-1 rounded-full text-xs whitespace-nowrap ${
            sortBy === 'rate'
              ? 'bg-blue-500 text-white'
              : 'bg-gray-100 text-gray-700'
          }`}
        >
          å¥½è¯„ç‡
        </button>
        <button
          onClick={() => setSortBy('price-asc')}
          className={`px-3 py-1 rounded-full text-xs whitespace-nowrap ${
            sortBy === 'price-asc'
              ? 'bg-blue-500 text-white'
              : 'bg-gray-100 text-gray-700'
          }`}
        >
          ä»·æ ¼ä»ä½åˆ°é«˜
        </button>
        <button
          onClick={() => setSortBy('sales')}
          className={`px-3 py-1 rounded-full text-xs whitespace-nowrap ${
            sortBy === 'sales'
              ? 'bg-blue-500 text-white'
              : 'bg-gray-100 text-gray-700'
          }`}
        >
          é”€é‡
        </button>
      </div>

      {/* å†…å®¹åŒºåŸŸ */}
      <div className="flex-1 overflow-y-auto p-4 pb-24 space-y-4">
        {/* æ™ºèƒ½æ¨èç»“è®º */}
        {renderSmartConclusion()}

        {/* äº§å“åˆ—è¡¨ */}
        {recommendations.map(product => renderProductCard(product))}

        {/* æŸ¥çœ‹æ›´å¤š */}
        <button className="w-full py-4 text-sm text-gray-600 border border-gray-200 rounded-xl bg-white">
          æŸ¥çœ‹æ›´å¤šäº§å“ â†’
        </button>
      </div>

      {/* åº•éƒ¨å¯¹æ¯”æ  */}
      {selectedForCompare.length > 0 && (
        <div className="fixed bottom-0 left-0 right-0 bg-white border-t px-4 py-3 max-w-md mx-auto z-50 shadow-lg">
          <div className="flex items-center justify-between">
            <div className="text-sm">
              å·²é€‰ <span className="font-bold text-blue-600">{selectedForCompare.length}</span>/3 ä¸ªäº§å“
            </div>
            <div className="flex gap-2">
              <button 
                onClick={() => setSelectedForCompare([])}
                className="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700"
              >
                æ¸…ç©º
              </button>
              <button 
                disabled={selectedForCompare.length < 2}
                className={`px-4 py-2 rounded-lg text-sm font-semibold ${
                  selectedForCompare.length >= 2
                    ? 'bg-blue-500 text-white'
                    : 'bg-gray-200 text-gray-400'
                }`}
              >
                å¼€å§‹å¯¹æ¯”
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default SmartRecommendationPage;
