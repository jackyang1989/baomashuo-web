import React, { useState } from 'react';
import { ArrowLeft, MoreVertical, Heart, MessageSquare, Share2, Bookmark, Star, TrendingUp, AlertTriangle, Users, Clock, ChevronRight, Send, Image, Smile, AtSign, Gift, Award, CheckCircle, Pin, Sparkles, ThumbsUp } from 'lucide-react';

const PostDetailPage = () => {
  const [liked, setLiked] = useState(false);
  const [bookmarked, setBookmarked] = useState(false);
  const [commentText, setCommentText] = useState('');
  const [replyingTo, setReplyingTo] = useState(null);
  const [showAllComments, setShowAllComments] = useState(false);

  // å¸–å­æ•°æ®
  const post = {
    id: 1,
    type: 'milestone',
    user: {
      name: 'å°é›¨å¦ˆå¦ˆ',
      avatar: 'ğŸ‘©',
      level: 'Lv5',
      levelName: 'èµ„æ·±å¦ˆå¦ˆ',
      badges: ['é‡‘ç‰Œè¯„ä»·å‘˜', 'æ´»è·ƒæ¦œTOP1'],
      isTopUser: true,
      followers: 234
    },
    content: 'å®å®ä»Šå¤©ç¬¬ä¸€æ¬¡ç¿»èº«æˆåŠŸäº†ï¼æ¿€åŠ¨åˆ°å“­ğŸ˜­\n\nä»ä¾§å§ç»ƒä¹ äº†ä¸¤å‘¨ï¼Œä»Šå¤©æ—©ä¸Šçªç„¶è‡ªå·±ç¿»è¿‡å»äº†ï¼å½“æ—¶æˆ‘æ­£åœ¨æ—è¾¹æ”¶æ‹¾ä¸œè¥¿ï¼Œçªç„¶å¬åˆ°å®å®"å’¿å‘€"å«ï¼Œä¸€çœ‹å·²ç»ç¿»è¿‡å»äº†ï¼Œå°å®¶ä¼™è¿˜å†²æˆ‘ç¬‘å‘¢ï¼\n\nåˆ†äº«ä¸€ä¸‹æˆ‘çš„ç»éªŒï¼š\n1. æ¯å¤©è¶´å§ç»ƒä¹ 15åˆ†é’Ÿï¼Œé”»ç‚¼é¢ˆéƒ¨å’Œæ‰‹è‡‚åŠ›é‡\n2. ä¾§å§æ—¶åœ¨èº«åæ”¾ä¸ªå°æ•å¤´åšæ”¯æ’‘\n3. åœ¨å‰æ–¹æ”¾ç©å…·å¸å¼•æ³¨æ„åŠ›\n4. ä¸è¦ç€æ€¥ï¼Œæ¯ä¸ªå®å®èŠ‚å¥ä¸ä¸€æ ·\n\nå§å¦¹ä»¬ï¼Œä½ ä»¬å®¶å®å®å¤šå¤§ç¿»èº«çš„ï¼Ÿæœ‰ä»€ä¹ˆç»éªŒåˆ†äº«å—ï¼Ÿ',
    images: ['ğŸ“¸', 'ğŸ“¸', 'ğŸ“¸', 'ğŸ“¸'],
    milestone: {
      name: 'ç¬¬ä¸€æ¬¡ç¿»èº«',
      icon: 'ğŸ¤¸',
      completedCount: 456,
      percentage: 16
    },
    topic: 'æˆé•¿é‡Œç¨‹ç¢‘',
    babyAge: '3ä¸ªæœˆ',
    time: '10åˆ†é’Ÿå‰',
    stats: {
      likes: 289,
      comments: 67,
      shares: 34,
      bookmarks: 45
    },
    location: 'åŒ—äº¬',
    isPinned: false,
    isHot: true
  };

  // è¯„è®ºæ•°æ®
  const comments = [
    {
      id: 1,
      user: {
        name: 'æ™´å¤©å¦ˆå¦ˆ',
        avatar: 'ğŸ‘±â€â™€ï¸',
        level: 'Lv4',
        babyAge: '4ä¸ªæœˆ'
      },
      content: 'æ­å–œæ­å–œï¼æˆ‘å®¶å®å®ä¹Ÿæ˜¯3ä¸ªæœˆç¿»èº«çš„ï¼Œå½“æ—¶ä¹Ÿæ˜¯è¶…çº§æ¿€åŠ¨ï¼',
      time: '5åˆ†é’Ÿå‰',
      likes: 23,
      replies: [
        {
          id: 11,
          user: {
            name: 'å°é›¨å¦ˆå¦ˆ',
            avatar: 'ğŸ‘©',
            level: 'Lv5',
            isAuthor: true
          },
          replyTo: 'æ™´å¤©å¦ˆå¦ˆ',
          content: 'è°¢è°¢ï¼çœ‹åˆ°å®å®è¿›æ­¥çœŸçš„å¾ˆå¼€å¿ƒğŸ˜Š',
          time: '3åˆ†é’Ÿå‰',
          likes: 5
        },
        {
          id: 12,
          user: {
            name: 'æš–æš–å¦ˆå’ª',
            avatar: 'ğŸ™‹â€â™€ï¸',
            level: 'Lv3',
            babyAge: '3ä¸ªæœˆ'
          },
          replyTo: 'æ™´å¤©å¦ˆå¦ˆ',
          content: 'è¯·æ•™ä¸€ä¸‹ï¼Œç¿»èº«åè¦æ³¨æ„ä»€ä¹ˆå—ï¼Ÿ',
          time: '2åˆ†é’Ÿå‰',
          likes: 2
        }
      ],
      isLiked: false
    },
    {
      id: 2,
      user: {
        name: 'èŒèŒå¦ˆ',
        avatar: 'ğŸ‘©â€ğŸ¦°',
        level: 'Lv3',
        babyAge: '2ä¸ªæœˆ'
      },
      content: 'è¯·æ•™æ¥¼ä¸»ï¼Œè¶´å§ç»ƒä¹ æ˜¯æ€ä¹ˆåšçš„ï¼Ÿæˆ‘å®¶å®å®ä¸€è¶´å°±å“­',
      time: '8åˆ†é’Ÿå‰',
      likes: 15,
      replies: [],
      isLiked: false,
      isQuestion: true
    },
    {
      id: 3,
      user: {
        name: 'ç”œç”œå¦ˆ',
        avatar: 'ğŸ‘±',
        level: 'Lv5',
        babyAge: '6ä¸ªæœˆ',
        verified: true
      },
      content: 'æ­å–œï¼åˆ†äº«ä¸ªå°æŠ€å·§ï¼šç¿»èº«åè¦ç‰¹åˆ«æ³¨æ„å®‰å…¨ï¼ŒåºŠä¸Šä¸è¦æ”¾æ•å¤´è¢«å­ï¼Œé˜²æ­¢çª’æ¯ã€‚æˆ‘å®¶å½“æ—¶å°±æ˜¯ç¿»èº«åè„¸åŸ‹è¿›æ•å¤´é‡Œäº†ï¼Œè¿˜å¥½åŠæ—¶å‘ç°ğŸ˜°',
      time: '15åˆ†é’Ÿå‰',
      likes: 45,
      replies: [],
      isLiked: false,
      isHelpful: true
    }
  ];

  // ç›¸å…³æ¨è
  const relatedPosts = [
    {
      id: 2,
      title: '3ä¸ªæœˆå®å®ç¿»èº«è®­ç»ƒå…¨æ”»ç•¥',
      user: 'è‚²å„¿ä¸“å®¶Lisa',
      likes: 567,
      comments: 89,
      isExpert: true
    },
    {
      id: 3,
      title: 'åˆ†äº«æˆ‘å®¶å®å®ç¿»èº«åçš„å°æ’æ›²',
      user: 'ä¹ä¹å¦ˆ',
      likes: 234,
      comments: 45
    }
  ];

  const handleLike = () => {
    setLiked(!liked);
  };

  const handleBookmark = () => {
    setBookmarked(!bookmarked);
  };

  const handleComment = () => {
    if (commentText.trim()) {
      // å‘é€è¯„è®ºé€»è¾‘
      setCommentText('');
      setReplyingTo(null);
    }
  };

  const handleReply = (comment) => {
    setReplyingTo(comment);
  };

  const renderCommentCard = (comment, isReply = false) => (
    <div key={comment.id} className={`${isReply ? 'ml-12' : ''} mb-3`}>
      <div className="flex gap-3">
        <div className="text-2xl flex-shrink-0">{comment.user.avatar}</div>
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-1">
            <span className="font-semibold text-sm">{comment.user.name}</span>
            {comment.user.isAuthor && (
              <span className="text-xs bg-blue-500 text-white px-2 py-0.5 rounded">
                ä½œè€…
              </span>
            )}
            {comment.user.verified && (
              <CheckCircle className="w-3 h-3 text-green-600" />
            )}
            <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">
              {comment.user.level}
            </span>
            {comment.user.babyAge && (
              <span className="text-xs text-gray-500">â€¢ {comment.user.babyAge}</span>
            )}
          </div>

          {/* å›å¤å¯¹è±¡ */}
          {comment.replyTo && (
            <div className="text-xs text-blue-600 mb-1">
              å›å¤ @{comment.replyTo}
            </div>
          )}

          {/* è¯„è®ºå†…å®¹ */}
          <div className={`text-sm text-gray-700 mb-2 ${
            comment.isQuestion ? 'bg-blue-50 border-l-2 border-blue-500 pl-2 py-1' : ''
          }`}>
            {comment.content}
          </div>

          {/* æ ‡è¯† */}
          {comment.isHelpful && (
            <div className="inline-flex items-center gap-1 text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded mb-2">
              <ThumbsUp className="w-3 h-3" />
              <span>æœ‰å¸®åŠ©çš„å›ç­”</span>
            </div>
          )}

          {/* äº’åŠ¨æ  */}
          <div className="flex items-center gap-4 text-xs text-gray-500">
            <span>{comment.time}</span>
            <button className={`flex items-center gap-1 ${comment.isLiked ? 'text-red-500' : ''}`}>
              <Heart className={`w-3 h-3 ${comment.isLiked ? 'fill-current' : ''}`} />
              <span>{comment.likes}</span>
            </button>
            <button onClick={() => handleReply(comment)}>å›å¤</button>
          </div>

          {/* äºŒçº§å›å¤ */}
          {comment.replies && comment.replies.length > 0 && (
            <div className="mt-3 space-y-3">
              {comment.replies.slice(0, showAllComments ? undefined : 2).map((reply) => (
                renderCommentCard(reply, true)
              ))}
              {comment.replies.length > 2 && !showAllComments && (
                <button 
                  onClick={() => setShowAllComments(true)}
                  className="text-xs text-blue-600 ml-12"
                >
                  æŸ¥çœ‹å…¨éƒ¨ {comment.replies.length} æ¡å›å¤ â†’
                </button>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );

  return (
    <div className="max-w-md mx-auto bg-gray-50 min-h-screen flex flex-col">
      {/* é¡¶éƒ¨å¯¼èˆª */}
      <div className="bg-white px-4 py-3 flex items-center justify-between shadow-sm sticky top-0 z-50">
        <button className="flex items-center gap-2">
          <ArrowLeft className="w-5 h-5" />
          <span className="font-semibold">å¸–å­è¯¦æƒ…</span>
        </button>
        <button>
          <MoreVertical className="w-5 h-5 text-gray-600" />
        </button>
      </div>

      {/* å†…å®¹åŒºåŸŸ */}
      <div className="flex-1 overflow-y-auto pb-24">
        {/* å¸–å­å†…å®¹ */}
        <div className="bg-white p-4 border-b-8 border-gray-100">
          {/* ç½®é¡¶/çƒ­é—¨æ ‡è¯† */}
          {(post.isPinned || post.isHot) && (
            <div className="flex items-center gap-2 mb-3">
              {post.isPinned && (
                <div className="flex items-center gap-1 text-orange-600 text-xs bg-orange-50 px-2 py-1 rounded">
                  <Pin className="w-3 h-3" />
                  <span>ç½®é¡¶</span>
                </div>
              )}
              {post.isHot && (
                <div className="flex items-center gap-1 text-red-600 text-xs bg-red-50 px-2 py-1 rounded">
                  <TrendingUp className="w-3 h-3" />
                  <span>çƒ­é—¨</span>
                </div>
              )}
            </div>
          )}

          {/* ç”¨æˆ·ä¿¡æ¯ */}
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-3">
              <div className="text-3xl">{post.user.avatar}</div>
              <div>
                <div className="flex items-center gap-2 mb-1">
                  <span className="font-bold text-base">{post.user.name}</span>
                  <span className="text-xs bg-gradient-to-r from-yellow-400 to-orange-400 text-white px-2 py-0.5 rounded">
                    {post.user.level}
                  </span>
                  {post.user.isTopUser && (
                    <div className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded flex items-center gap-1">
                      <Award className="w-3 h-3" />
                      <span>æ´»è·ƒæ¦œ1</span>
                    </div>
                  )}
                </div>
                <div className="flex items-center gap-2 text-xs text-gray-500">
                  <span>{post.babyAge}å®å®</span>
                  <span>â€¢</span>
                  <span>{post.time}</span>
                  {post.location && (
                    <>
                      <span>â€¢</span>
                      <span>{post.location}</span>
                    </>
                  )}
                </div>
              </div>
            </div>
            <button className="text-blue-600 text-sm font-semibold px-4 py-1 border border-blue-600 rounded-lg">
              å…³æ³¨
            </button>
          </div>

          {/* å†…å®¹æ ‡ç­¾ */}
          <div className="flex items-center gap-2 mb-3">
            {post.type === 'milestone' && (
              <div className="flex items-center gap-1 bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-full">
                <Sparkles className="w-3 h-3" />
                <span>æˆé•¿é‡Œç¨‹ç¢‘</span>
              </div>
            )}
            {post.topic && (
              <div className="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded-full">
                #{post.topic}
              </div>
            )}
          </div>

          {/* é‡Œç¨‹ç¢‘è¿›åº¦ */}
          {post.milestone && (
            <div className="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-200 rounded-xl p-3 mb-3">
              <div className="flex items-center gap-2 mb-2">
                <div className="text-2xl">{post.milestone.icon}</div>
                <div>
                  <div className="font-bold text-gray-800">{post.milestone.name}</div>
                  <div className="text-xs text-gray-600">
                    {post.milestone.completedCount}ä½å®å®å·²è¾¾æˆ â€¢ {post.milestone.percentage}%
                  </div>
                </div>
              </div>
              <div className="bg-white rounded-full h-2 overflow-hidden">
                <div 
                  className="bg-gradient-to-r from-yellow-400 to-orange-400 h-full"
                  style={{ width: `${post.milestone.percentage}%` }}
                ></div>
              </div>
            </div>
          )}

          {/* å¸–å­æ­£æ–‡ */}
          <div className="text-base text-gray-800 leading-relaxed mb-3 whitespace-pre-line">
            {post.content}
          </div>

          {/* å›¾ç‰‡ç½‘æ ¼ */}
          {post.images && post.images.length > 0 && (
            <div className={`grid gap-2 mb-3 ${
              post.images.length === 1 ? 'grid-cols-1' :
              post.images.length === 2 ? 'grid-cols-2' :
              post.images.length === 3 ? 'grid-cols-3' :
              'grid-cols-3'
            }`}>
              {post.images.map((img, idx) => (
                <div 
                  key={idx} 
                  className={`bg-gray-100 rounded-xl flex items-center justify-center text-6xl ${
                    post.images.length === 1 ? 'aspect-video' : 'aspect-square'
                  }`}
                >
                  {img}
                </div>
              ))}
            </div>
          )}

          {/* äº’åŠ¨æ•°æ® */}
          <div className="flex items-center justify-between py-3 border-t border-b text-sm text-gray-600">
            <div className="flex items-center gap-4">
              <span>{post.stats.likes}èµ</span>
              <span>{post.stats.comments}è¯„è®º</span>
              <span>{post.stats.shares}åˆ†äº«</span>
            </div>
            <span>{post.stats.bookmarks}æ”¶è—</span>
          </div>

          {/* äº’åŠ¨æŒ‰é’® */}
          <div className="flex items-center justify-around py-3">
            <button 
              onClick={handleLike}
              className={`flex items-center gap-1 ${liked ? 'text-red-500' : 'text-gray-600'}`}
            >
              <Heart className={`w-5 h-5 ${liked ? 'fill-current' : ''}`} />
              <span className="text-sm">{liked ? 'å·²èµ' : 'èµ'}</span>
            </button>
            <button className="flex items-center gap-1 text-gray-600">
              <MessageSquare className="w-5 h-5" />
              <span className="text-sm">è¯„è®º</span>
            </button>
            <button className="flex items-center gap-1 text-gray-600">
              <Share2 className="w-5 h-5" />
              <span className="text-sm">åˆ†äº«</span>
            </button>
            <button 
              onClick={handleBookmark}
              className={`flex items-center gap-1 ${bookmarked ? 'text-blue-500' : 'text-gray-600'}`}
            >
              <Bookmark className={`w-5 h-5 ${bookmarked ? 'fill-current' : ''}`} />
              <span className="text-sm">{bookmarked ? 'å·²æ”¶è—' : 'æ”¶è—'}</span>
            </button>
          </div>
        </div>

        {/* è¯„è®ºåŒº */}
        <div className="bg-white p-4">
          <div className="flex items-center justify-between mb-4">
            <h3 className="font-bold text-gray-800">
              å…¨éƒ¨è¯„è®º <span className="text-gray-500">({post.stats.comments})</span>
            </h3>
            <button className="text-sm text-gray-600 flex items-center gap-1">
              <TrendingUp className="w-4 h-4" />
              <span>æŒ‰çƒ­åº¦</span>
            </button>
          </div>

          {/* è¯„è®ºåˆ—è¡¨ */}
          <div className="space-y-4">
            {comments.map((comment) => renderCommentCard(comment))}
          </div>

          {/* åŠ è½½æ›´å¤š */}
          <button className="w-full py-3 text-sm text-gray-600 border-t mt-4">
            æŸ¥çœ‹æ›´å¤šè¯„è®º â†’
          </button>
        </div>

        {/* ç›¸å…³æ¨è */}
        <div className="bg-white p-4 mt-2">
          <h3 className="font-bold text-gray-800 mb-3">ç›¸å…³æ¨è</h3>
          <div className="space-y-3">
            {relatedPosts.map((relatedPost) => (
              <div key={relatedPost.id} className="bg-gray-50 rounded-xl p-3 hover:bg-gray-100 transition-all cursor-pointer">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="font-medium text-sm text-gray-800">{relatedPost.title}</span>
                      {relatedPost.isExpert && (
                        <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">
                          ä¸“å®¶
                        </span>
                      )}
                    </div>
                    <div className="text-xs text-gray-500 mb-2">{relatedPost.user}</div>
                    <div className="flex items-center gap-3 text-xs text-gray-500">
                      <span className="flex items-center gap-1">
                        <Heart className="w-3 h-3" />
                        {relatedPost.likes}
                      </span>
                      <span className="flex items-center gap-1">
                        <MessageSquare className="w-3 h-3" />
                        {relatedPost.comments}
                      </span>
                    </div>
                  </div>
                  <ChevronRight className="w-5 h-5 text-gray-400 flex-shrink-0" />
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* åº•éƒ¨è¯„è®ºè¾“å…¥æ¡† */}
      <div className="bg-white border-t px-4 py-3 fixed bottom-0 left-0 right-0 max-w-md mx-auto z-50">
        {replyingTo && (
          <div className="flex items-center justify-between mb-2 text-xs text-gray-600 bg-blue-50 px-3 py-2 rounded-lg">
            <span>å›å¤ @{replyingTo.user.name}</span>
            <button onClick={() => setReplyingTo(null)}>âœ•</button>
          </div>
        )}
        <div className="flex items-center gap-2">
          <input
            type="text"
            value={commentText}
            onChange={(e) => setCommentText(e.target.value)}
            placeholder={replyingTo ? `å›å¤ @${replyingTo.user.name}` : 'è¯´ç‚¹ä»€ä¹ˆ...'}
            className="flex-1 px-4 py-2 bg-gray-100 rounded-full focus:outline-none focus:bg-white focus:border focus:border-blue-500"
          />
          <button className="text-gray-400">
            <Smile className="w-5 h-5" />
          </button>
          <button className="text-gray-400">
            <Image className="w-5 h-5" />
          </button>
          <button 
            onClick={handleComment}
            disabled={!commentText.trim()}
            className={`px-4 py-2 rounded-full font-semibold ${
              commentText.trim()
                ? 'bg-blue-500 text-white'
                : 'bg-gray-200 text-gray-400'
            }`}
          >
            å‘é€
          </button>
        </div>
      </div>
    </div>
  );
};

export default PostDetailPage;
